name: Build Pacman Package

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  pacman:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: dtolnay/rust-toolchain@stable

      - name: Configure Rust for CI
        run: |
          # Reduce parallel jobs to prevent resource exhaustion
          echo "CARGO_BUILD_JOBS=2" >> $GITHUB_ENV
          # Limit rustc parallel codegen units
          echo "RUSTFLAGS=-C codegen-units=1 -C opt-level=1" >> $GITHUB_ENV
          # Disable incremental compilation to save disk space
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            fakeroot \
            libarchive-tools \
            python3-venv \
            zstd
          corepack enable

      - name: Prepare Python tooling
        run: |
          python -m pip install --upgrade pip
          pip install build installer

      - name: Build Python wheel
        run: python -m build --wheel

      - name: Create pacman package
        env:
          PKG_NAME: anki-ai
        run: |
          set -euxo pipefail
          WHEEL=$(ls dist/anki-*.whl | head -n1)
          if [[ -z "$WHEEL" || ! -f "$WHEEL" ]]; then
            echo "Error: No wheel file found in dist/" >&2
            exit 1
          fi
          VERSION=$(cat .version)
          PKGDIR="$GITHUB_WORKSPACE/out/pacman/pkgroot"
          ARTIFACT_DIR="$GITHUB_WORKSPACE/out/pacman"
          rm -rf "$ARTIFACT_DIR"
          mkdir -p "$PKGDIR/usr/bin"
          python -m installer --destdir "$PKGDIR" --prefix /usr "$WHEEL"
          cat <<'SCRIPT' > "$PKGDIR/usr/bin/anki"
          #!/usr/bin/env python3
          import runpy
          runpy.run_module("aqt", run_name="__main__")
          SCRIPT
          chmod +x "$PKGDIR/usr/bin/anki"
          SIZE=$(du -sb "$PKGDIR" | cut -f1)
          cat > "$PKGDIR/.PKGINFO" <<PKGINFO
          pkgname = ${PKG_NAME}
          pkgver = ${VERSION}
          pkgrel = 1
          pkgdesc = Anki with AI generation support (development build)
          url = https://github.com/beenycool/anki
          builddate = $(date +%s)
          packager = GitHub Actions
          size = ${SIZE}
          arch = x86_64
          license = AGPL3
          depend = python
          depend = python-pyqt6
          depend = python-pyqt6-webengine
          depend = sqlite
          PKGINFO
          (cd "$PKGDIR" && fakeroot bsdtar --format=mtree --options='!all,use-set,type,uid,gid,mode,time' -f .MTREE .)
          PACKAGE_FILE="${ARTIFACT_DIR}/${PKG_NAME}-${VERSION}-1-x86_64.pkg.tar.zst"
          mkdir -p "$ARTIFACT_DIR"
          (cd "$PKGDIR" && fakeroot tar --zstd -cf "$PACKAGE_FILE" .PKGINFO .MTREE usr)

      - name: Upload pacman package
        uses: actions/upload-artifact@v4
        with:
          name: pacman-package
          path: out/pacman/*.pkg.tar.zst
          if-no-files-found: error
